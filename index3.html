<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>My first three.js app</title>
    <style>
        body { margin: 0; }
    </style>
</head>
<body>

<div id="tooltip"></div>
<script src="js/three.js"></script>
<script>
    var scene = new THREE.Scene();
    var raycaster = new THREE.Raycaster();

    //create some camera
    camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.x = 1;
    camera.position.y = 1;
    camera.position.z = 3;
    camera.lookAt(0, 0, 0);

    // var controls = new THREE.OrbitControls(camera);

    var renderer = new THREE.WebGLRenderer({
        antialias: true
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(new THREE.Color(0x595959));
    document.body.appendChild(renderer.domElement);

    // white spotlight shining from the side, casting a shadow
    var spotLight = new THREE.SpotLight(0xffffff, 2.5, 25, Math.PI / 6);
    spotLight.position.set(4, 10, 7);
    scene.add(spotLight);

    // collect objects for raycasting,
    // for better performance don't raytrace all scene
    var tooltipEnabledObjects = [];

    // var colors = new RayysWebColors();
    var boxGeometry = new THREE.PlaneGeometry(1, 1);
    var boxMaterial = new THREE.MeshPhongMaterial({
        // color: colors.pickRandom().hex,
        transparent: true,
        opacity: 0.75
    });
    var box = new THREE.Mesh(boxGeometry, boxMaterial);
    scene.add(box);

    var size = 0.05;
    var vertGeometry = new THREE.CircleGeometry(size, 32);
    var vertMaterial = new THREE.MeshBasicMaterial({
        color: "white",
        transparent: false,

    });

    var verts = boxGeometry.attributes.position.array;
    for (let k=0; k<verts.length; k+=3) {
        var vertMarker = new THREE.Mesh(vertGeometry, vertMaterial);

        // this is how tooltip text is defined for each box
        let tooltipText = `idx: ${k}, pos: [${verts[k].toFixed(3)},${verts[k+1].toFixed(3)},${verts[k+2].toFixed(3)}]`;
        vertMarker.userData.tooltipText = tooltipText;

        vertMarker.applyMatrix4 (new THREE.Matrix4().makeTranslation(verts[k],verts[k+1],verts[k+2]));
        scene.add(vertMarker);
        tooltipEnabledObjects.push(vertMarker);
    }

    function animate() {
        requestAnimationFrame(animate);
        // controls.update();
        renderer.render(scene, camera);
    };

    // this will be 2D coordinates of the current mouse position, [0,0] is middle of the screen.
    var mouse = new THREE.Vector2();

    var latestMouseProjection; // this is the latest projection of the mouse on object (i.e. intersection with ray)
    var hoveredObj; // this objects is hovered at the moment

    // tooltip will not appear immediately. If object was hovered shortly,
    // - the timer will be canceled and tooltip will not appear at all.
    var tooltipDisplayTimeout;

    // This will move tooltip to the current mouse position and show it by timer.
    function showTooltip() {
        var divElement = document.querySelector("#tooltip");

        if (divElement && latestMouseProjection) {
            divElement.style.display = "block"
            divElement.style.opacity = "0.0"


            var canvasHalfWidth = renderer.domElement.offsetWidth / 2;
            var canvasHalfHeight = renderer.domElement.offsetHeight / 2;

            var tooltipPosition = latestMouseProjection.clone().project(camera);
            tooltipPosition.x = (tooltipPosition.x * canvasHalfWidth) + canvasHalfWidth + renderer.domElement.offsetLeft;
            tooltipPosition.y = -(tooltipPosition.y * canvasHalfHeight) + canvasHalfHeight + renderer.domElement.offsetTop;

            var tootipWidth = [0].offsetWidth;
            var tootipHeight = divElement.odivElementffsetHeight;

            divElement.style.left = `${tooltipPosition.x - tootipWidth/2}px`
            divElement.style.top =  `${tooltipPosition.y - tootipHeight - 5}px`


            // var position = new THREE.Vector3();
            // var quaternion = new THREE.Quaternion();
            // var scale = new THREE.Vector3();
            // hoveredObj.matrix.decompose(position, quaternion, scale);
            divElement.innerText = hoveredObj.userData.tooltipText;

            setTimeout(function() {
                divElement.style.opacity = "1.0"
            }, 25);
        }
    }

    // This will immediately hide tooltip.
    function hideTooltip() {
        var divElement = document.querySelector("#tooltip");
        if (divElement) {
            divElement.style.display = "none"

        }
    }

    // Following two functions will convert mouse coordinates
    // from screen to three.js system (where [0,0] is in the middle of the screen)
    function updateMouseCoords(event, coordsObj) {
        coordsObj.x = ((event.clientX - renderer.domElement.offsetLeft + 0.5) / window.innerWidth) * 2 - 1;
        coordsObj.y = -((event.clientY - renderer.domElement.offsetTop + 0.5) / window.innerHeight) * 2 + 1;
    }

    function handleManipulationUpdate() {
        raycaster.setFromCamera(mouse, camera);
        {
            var intersects = raycaster.intersectObjects(tooltipEnabledObjects);
            if (intersects.length > 0) {
                latestMouseProjection = intersects[0].point;
                hoveredObj = intersects[0].object;
            }
        }

        if (tooltipDisplayTimeout || !latestMouseProjection) {
            clearTimeout(tooltipDisplayTimeout);
            tooltipDisplayTimeout = undefined;
            hideTooltip();
        }

        if (!tooltipDisplayTimeout && latestMouseProjection) {
            tooltipDisplayTimeout = setTimeout(function() {
                tooltipDisplayTimeout = undefined;
                showTooltip();
            }, 330);
        }
    }

    function onMouseMove(event) {
        updateMouseCoords(event, mouse);

        latestMouseProjection = undefined;
        hoveredObj = undefined;
        handleManipulationUpdate();
    }

    window.addEventListener('mousemove', onMouseMove, false);

    animate();

</script>
</body>
</html>